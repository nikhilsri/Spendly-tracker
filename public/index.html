<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#020617" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>Spendly ‚Äì Couple AI Expense Tracker</title>
    <style>
        :root {
            --bg:#020617;--card:#0f172a;--accent:#38bdf8;--danger:#f87171;--text:#e5e7eb;--muted:#94a3b8;
        }
        *{box-sizing:border-box;font-family:Inter,system-ui}
        body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto}
        .app{width:100%;max-width:460px;background:var(--card);border-radius:24px;padding:20px;box-shadow:0 25px 60px rgba(0,0,0,.6)}
        h1{margin:0;font-size:22px}
        p{margin:4px 0 12px;color:var(--muted);font-size:13px}
        .row{display:flex;gap:10px;margin-bottom:8px}
        input,select{
            width:100%;
            padding:12px;
            border-radius:14px;
            border:none;
            background:#020617;
            color:var(--text);
            font-size:14px;
            appearance:auto;
            -webkit-appearance:auto;
            pointer-events:auto;
        }
        button{width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#38bdf8,#6366f1);color:#020617;font-weight:800;cursor:pointer}
        ul{list-style:none;padding:0;margin:12px 0}
        li{background:#020617;padding:12px 14px;border-radius:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
        .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:#1e293b;color:var(--muted)}
        .pill.me{background:#1e40af;color:#bfdbfe}
        .pill.partner{background:#4c1d95;color:#ddd6fe}
        .delete{background:none;border:none;color:var(--danger);cursor:pointer}
        .ai{margin-top:12px;background:#020617;border-radius:16px;padding:12px;font-size:13px;color:var(--muted)}
        canvas{margin-top:14px}
        .section{background:#020617;border-radius:16px;padding:14px;margin-top:14px}
        .section-title{font-size:14px;font-weight:700;margin-bottom:10px;color:var(--accent)}
        .income-row{display:flex;gap:10px;align-items:center}
        .income-display{font-size:20px;font-weight:800;color:#4ade80}
        .budget-item{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .budget-item label{flex:1;font-size:12px;color:var(--muted)}
        .budget-item input{width:100px;text-align:right}
        .budget-bar{height:6px;background:#1e293b;border-radius:99px;margin-top:4px;overflow:hidden}
        .budget-bar-fill{height:100%;border-radius:99px;transition:width 0.3s}
        .budget-summary{display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #1e293b;margin-top:10px;font-size:13px}
        .budget-remaining{color:#4ade80;font-weight:700}
        .budget-remaining.negative{color:#f87171}
        .collapse-btn{background:none;border:none;color:var(--accent);font-size:12px;cursor:pointer;padding:0;width:auto}
        .collapsible{transition:max-height 0.3s ease-out}
        .collapsed{max-height:0 !important;overflow:hidden}
        .ai-advisor{background:linear-gradient(135deg,#1e1b4b,#0f172a);border:1px solid #3730a3;border-radius:16px;padding:14px;margin-top:14px}
        .ai-advisor-title{font-size:14px;font-weight:700;color:#a78bfa;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .ai-suggestions{font-size:13px;line-height:1.6}
        .ai-suggestion{background:#020617;border-radius:12px;padding:12px;margin-bottom:8px;border-left:3px solid #8b5cf6}
        .ai-suggestion.positive{border-left-color:#4ade80}
        .ai-suggestion.warning{border-left-color:#facc15}
        .ai-suggestion.danger{border-left-color:#f87171}
        .ai-btn{background:linear-gradient(135deg,#8b5cf6,#6366f1);margin-top:10px}
        .ai-loading{text-align:center;color:var(--muted);padding:20px}
        .gemini-input{margin-top:10px;display:flex;gap:8px}
        .gemini-input input{flex:1;font-size:12px}
        .expense-summary{background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:16px;padding:16px;margin:14px 0;border:1px solid #334155}
        .expense-summary-title{font-size:12px;color:var(--muted);margin-bottom:8px}
        .expense-total{font-size:28px;font-weight:800;color:#f87171}
        .expense-split{display:flex;gap:12px;margin-top:12px}
        .expense-split-item{flex:1;background:#020617;border-radius:12px;padding:10px;text-align:center}
        .expense-split-label{font-size:11px;color:var(--muted)}
        .expense-split-value{font-size:16px;font-weight:700;margin-top:4px}
        .expense-split-value.me{color:#60a5fa}
        .expense-split-value.partner{color:#c084fc}
        .expense-vs-budget{margin-top:12px;padding-top:12px;border-top:1px solid #334155}
        .expense-bar{height:8px;background:#1e293b;border-radius:99px;overflow:hidden;margin-top:6px}
        .expense-bar-fill{height:100%;border-radius:99px;transition:width 0.3s}
        .expense-status{font-size:11px;margin-top:6px}
        .category-group{background:#0f172a;border-radius:14px;margin-bottom:8px;overflow:hidden}
        .category-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;transition:background 0.2s}
        .category-header:hover{background:#1e293b}
        .category-header-left{display:flex;align-items:center;gap:10px}
        .category-icon{font-size:18px}
        .category-name{font-size:13px;font-weight:600}
        .category-count{font-size:11px;color:var(--muted);background:#1e293b;padding:2px 8px;border-radius:99px}
        .category-total{font-size:14px;font-weight:700;color:var(--accent)}
        .category-arrow{color:var(--muted);transition:transform 0.2s}
        .category-arrow.expanded{transform:rotate(180deg)}
        .category-items{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out}
        .category-items.expanded{max-height:1000px}
        .category-item{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-top:1px solid #1e293b;font-size:13px}
        .category-item-info{display:flex;align-items:center;gap:8px}
        .category-item-date{font-size:11px;color:var(--muted)}
    </style>
</head>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
        getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCVP058K-vfHdmNS3HkR7j9LofDG8i3Kdc",
        authDomain: "spendly-tracker.firebaseapp.com",
        projectId: "spendly-tracker",
        storageBucket: "spendly-tracker.firebasestorage.app",
        messagingSenderId: "193786715968",
        appId: "1:193786715968:web:43d3279fe2ef3049e8e4a5",
        measurementId: "G-2MPDP7KWGL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.firebase = { auth, db, provider };
    let expenses = [];
    function subscribeToExpenses() {
        const q = query(
            collection(db, "users", userId, "expenses"),
            orderBy("date", "desc")
        );

        onSnapshot(q, snapshot => {
            expenses = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            render();
        });
    }
    const loginBtn = document.getElementById('loginBtn');
    let userId = null;
    loginBtn.onclick = async () => {
        await signInWithPopup(auth, provider);
    };
    onAuthStateChanged(auth, async user => {
        if (!user) return;
        userId = user.uid;
        loginBtn.style.display = 'none';
        subscribeToExpenses();
        await loadIncomeAndBudget();
    });
    const monthFilter=document.getElementById('monthFilter');
    const amountInput=document.getElementById('amount');
    const currencyInput=document.getElementById('currency');
    const categoryInput=document.getElementById('category');
    const ownerInput=document.getElementById('owner');
    const list=document.getElementById('list');
    const aiBox=document.getElementById('ai');
    const trendCtx=document.getElementById('trend').getContext('2d');
    const compareCtx=document.getElementById('compare').getContext('2d');
    const categoryPieCtx=document.getElementById('categoryPie').getContext('2d');

    let trendChart=null,compareChart=null,categoryPieChart=null;

    monthFilter.value=new Date().toISOString().slice(0,7);
    monthFilter.addEventListener('change',render);
    async function addExpense() {
        monthFilter.value = new Date().toISOString().slice(0,7);

        const amount = Number(amountInput.value);
        if (!amount || amount <= 0) return;

        await addDoc(
            collection(db, "users", userId, "expenses"),
            {
                amount,
                currency: currencyInput.value,
                category: categoryInput.value,
                owner: ownerInput.value,
                date: new Date().toISOString()
            }
        );

        amountInput.value = "";
    }
    /*function addExpense(){
        monthFilter.value=new Date().toISOString().slice(0,7);
        const amount=Number(amountInput.value);
        if(!amount||amount<=0)return;
        expenses.push({id:Date.now(),amount,currency:currencyInput.value,category:categoryInput.value,owner:ownerInput.value,date:new Date().toISOString()});
        amountInput.value='';save();
    }*/

    document.getElementById('addBtn').onclick=addExpense;

    async function deleteExpense(id){
        await deleteDoc(doc(db, "users", userId, "expenses", id));
    }
    window.deleteExpense = deleteExpense;

    const categoryIcons = {
        'Food': 'üçî', 'Travel': '‚úàÔ∏è', 'Groceries': 'üõí', 'Shopping': 'üõçÔ∏è',
        'Entertainment': 'üé¨', 'Health': 'üíä', 'Common (Rent/Bills/EMIs)': 'üè†',
        'Family Transfers': 'üë®‚Äçüë©‚Äçüëß', 'Bank Deposits': 'üè¶', 'Mutual Funds/Stocks': 'üìà', 'Other': 'üì¶'
    };

    function render(){
        list.innerHTML='';
        const m=monthFilter.value;
        const filtered=expenses.filter(e=>e.date.startsWith(m));
        let me=0,partner=0;

        // Group expenses by category
        const grouped = {};
        filtered.forEach(e => {
            if(e.owner==='me') me+=e.amount; else partner+=e.amount;
            if (!grouped[e.category]) {
                grouped[e.category] = { items: [], total: 0 };
            }
            grouped[e.category].items.push(e);
            grouped[e.category].total += e.amount;
        });

        // Sort categories by total (highest first)
        const sortedCategories = Object.entries(grouped)
            .sort((a, b) => b[1].total - a[1].total);

        // Render grouped expenses
        sortedCategories.forEach(([category, data]) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'category-group';
            
            const icon = categoryIcons[category] || 'üì¶';
            const itemCount = data.items.length;
            
            groupDiv.innerHTML = `
                <div class="category-header" onclick="this.nextElementSibling.classList.toggle('expanded'); this.querySelector('.category-arrow').classList.toggle('expanded')">
                    <div class="category-header-left">
                        <span class="category-icon">${icon}</span>
                        <span class="category-name">${category}</span>
                        <span class="category-count">${itemCount} item${itemCount > 1 ? 's' : ''}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px">
                        <span class="category-total">${format(data.total)}</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                </div>
                <div class="category-items">
                    ${data.items.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `
                        <div class="category-item">
                            <div class="category-item-info">
                                <span class="pill ${e.owner}">${e.owner === 'me' ? 'Nikku' : 'Wifey'}</span>
                                <span class="category-item-date">${new Date(e.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span>${format(e.amount, e.currency)}</span>
                                <button class="delete" onclick="deleteExpense('${e.id}')">‚úï</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            list.appendChild(groupDiv);
        });

        // Show message if no expenses
        if (sortedCategories.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No expenses this month</div>';
        }

        // Update monthly expense summary
        const totalSpent = me + partner;
        document.getElementById('monthlyTotal').textContent = format(totalSpent);
        document.getElementById('nikkuTotal').textContent = format(me);
        document.getElementById('wifeyTotal').textContent = format(partner);

        // Update budget comparison
        updateBudgetComparison(totalSpent);

        renderCategoryPie(filtered);
        renderTrend();
        renderCompare();
        aiBox.innerHTML=generateAI(me,partner);
    }

    function updateBudgetComparison(totalSpent) {
        // Compare against total expense budget (all spending categories except investments)
        const budgetTotal = (budgetPlan.Rent || 0) + (budgetPlan.Entertainment || 0) + 
                           (budgetPlan.Shopping || 0) + (budgetPlan.Food || 0) + (budgetPlan.Other || 0);
        
        const comparison = document.getElementById('budgetComparison');
        const pctEl = document.getElementById('budgetUsedPct');
        const barEl = document.getElementById('budgetUsedBar');
        const statusEl = document.getElementById('budgetStatus');

        if (budgetTotal <= 0) {
            comparison.style.display = 'none';
            return;
        }

        comparison.style.display = 'block';
        const pct = (totalSpent / budgetTotal) * 100;
        pctEl.textContent = pct.toFixed(1) + '%';
        barEl.style.width = Math.min(pct, 100) + '%';

        if (pct <= 50) {
            barEl.style.background = '#4ade80';
            statusEl.innerHTML = `<span style="color:#4ade80">‚úì On track!</span> ${format(budgetTotal - totalSpent)} remaining`;
        } else if (pct <= 80) {
            barEl.style.background = '#facc15';
            statusEl.innerHTML = `<span style="color:#facc15">‚ö† ${format(budgetTotal - totalSpent)} remaining</span> ‚Äî be mindful`;
        } else if (pct <= 100) {
            barEl.style.background = '#fb923c';
            statusEl.innerHTML = `<span style="color:#fb923c">‚ö† Almost at limit!</span> Only ${format(budgetTotal - totalSpent)} left`;
        } else {
            barEl.style.background = '#f87171';
            statusEl.innerHTML = `<span style="color:#f87171">üö® Over budget by ${format(totalSpent - budgetTotal)}!</span>`;
        }
    }

    function generateAI(me,partner){
        if(me+partner===0)return'No entries this month';
        if(me>partner*1.5)return'üí° Nikku is spending much more this month';
        if(partner>me*1.5)return'üí° Wifey is spending much more this month';
        return`üíë Balanced month ‚Äî Nikku ${format(me)} | Wifey ${format(partner)}`;
    }

    // ===== CATEGORY PIE CHART =====
    const categoryColors = {
        'Food': '#f87171',
        'Travel': '#fb923c',
        'Groceries': '#a3e635',
        'Shopping': '#38bdf8',
        'Entertainment': '#c084fc',
        'Health': '#4ade80',
        'Common (Rent/Bills/EMIs)': '#facc15',
        'Family Transfers': '#f472b6',
        'Bank Deposits': '#22d3ee',
        'Mutual Funds/Stocks': '#818cf8',
        'Other': '#94a3b8'
    };

    function renderCategoryPie(filtered) {
        if (categoryPieChart) categoryPieChart.destroy();
        
        const categoryTotals = {};
        filtered.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });
        
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const colors = labels.map(cat => categoryColors[cat] || '#94a3b8');
        
        if (labels.length === 0) return;
        
        categoryPieChart = new Chart(categoryPieCtx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderColor: '#0f172a',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 8, font: { size: 11 } }
                    },
                    title: {
                        display: true,
                        text: 'Category Breakdown',
                        color: '#e5e7eb',
                        font: { size: 14 }
                    }
                }
            }
        });
    }

    // ===== AUTO ARCHIVE + 6 MONTH TREND =====
    function lastMonths(n){
        const arr=[];const d=new Date();
        for(let i=0;i<n;i++){arr.unshift(new Date(d.getFullYear(),d.getMonth()-i,1).toISOString().slice(0,7));}
        return arr;
    }

    function renderTrend(){
        if(trendChart)trendChart.destroy();
        const months=lastMonths(6);
        const totals=months.map(m=>expenses.filter(e=>e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));
        trendChart=new Chart(trendCtx,{type:'line',data:{labels:months,datasets:[{data:totals,label:'6‚ÄëMonth Trend'}]},options:{plugins:{legend:{labels:{color:'#94a3b8'}}}}});
    }

    // ===== MONTH‚ÄëTO‚ÄëMONTH COMPARISON =====
    function renderCompare(){
        if(compareChart)compareChart.destroy();
        const months=lastMonths(2);
        const totals=months.map(m=>expenses.filter(e=>e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));
        compareChart=new Chart(compareCtx,{type:'bar',data:{labels:months,datasets:[{data:totals,label:'Month Comparison'}]},options:{plugins:{legend:{labels:{color:'#94a3b8'}}}}});
    }

    const currencyMap={INR:{s:'‚Çπ',l:'en-IN'},USD:{s:'$',l:'en-US'},EUR:{s:'‚Ç¨',l:'de-DE'},THB:{s:'‡∏ø',l:'th-TH'},MYR:{s:'RM',l:'ms-MY'}};
    function format(n,c='INR'){const x=currencyMap[c]||currencyMap.INR;return x.s+n.toLocaleString(x.l,{minimumFractionDigits:2,maximumFractionDigits:2});}

    // ===== INCOME & BUDGET =====
    const budgetFields = ['Rent', 'MF', 'Stocks', 'Gold', 'Entertainment', 'Shopping', 'Food', 'Other', 'Liquid'];
    const budgetColors = {
        Rent: '#facc15', MF: '#818cf8', Stocks: '#38bdf8', Gold: '#fbbf24',
        Entertainment: '#c084fc', Shopping: '#f472b6', Food: '#f87171', Other: '#94a3b8', Liquid: '#4ade80'
    };
    const budgetLabels = {
        Rent: 'üè† Rent/Bills', MF: 'üìà Mutual Funds', Stocks: 'üìä Stocks', Gold: 'ü™ô Gold',
        Entertainment: 'üé¨ Entertainment', Shopping: 'üõçÔ∏è Shopping', Food: 'üçî Food', Other: 'üì¶ Other', Liquid: 'üíß Liquid'
    };

    let monthlyIncome = 0;
    let budgetPlan = {};

    // Toggle budget section
    document.getElementById('toggleBudget').onclick = () => {
        const section = document.getElementById('budgetSection');
        const btn = document.getElementById('toggleBudget');
        section.classList.toggle('collapsed');
        btn.textContent = section.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    };

    // Save income
    document.getElementById('saveIncomeBtn').onclick = async () => {
        const income = Number(document.getElementById('incomeInput').value);
        if (!income || income <= 0 || !userId) return;
        
        await setDoc(doc(db, "users", userId, "settings", "income"), { amount: income });
        monthlyIncome = income;
        updateIncomeDisplay();
        updateBudgetVisual();
    };

    // Save budget
    document.getElementById('saveBudgetBtn').onclick = async () => {
        if (!userId) return;
        
        const plan = {};
        budgetFields.forEach(field => {
            const val = Number(document.getElementById('budget' + field).value) || 0;
            plan[field] = val;
        });
        
        await setDoc(doc(db, "users", userId, "settings", "budget"), plan);
        budgetPlan = plan;
        updateBudgetVisual();
    };

    // Load income and budget on auth
    async function loadIncomeAndBudget() {
        if (!userId) return;
        
        try {
            const incomeDoc = await getDoc(doc(db, "users", userId, "settings", "income"));
            if (incomeDoc.exists()) {
                monthlyIncome = incomeDoc.data().amount || 0;
                document.getElementById('incomeInput').value = monthlyIncome;
                updateIncomeDisplay();
            }
            
            const budgetDoc = await getDoc(doc(db, "users", userId, "settings", "budget"));
            if (budgetDoc.exists()) {
                budgetPlan = budgetDoc.data();
                budgetFields.forEach(field => {
                    document.getElementById('budget' + field).value = budgetPlan[field] || '';
                });
            }
            updateBudgetVisual();
        } catch (err) {
            console.log('Error loading settings:', err);
        }
    }

    function updateIncomeDisplay() {
        const display = document.getElementById('incomeDisplay');
        const amount = document.getElementById('incomeAmount');
        if (monthlyIncome > 0) {
            display.style.display = 'block';
            amount.textContent = format(monthlyIncome);
        } else {
            display.style.display = 'none';
        }
    }

    function updateBudgetVisual() {
        const container = document.getElementById('budgetVisual');
        const totalAllocatedEl = document.getElementById('totalAllocated');
        const remainingEl = document.getElementById('budgetRemaining');
        
        let total = 0;
        let html = '';
        
        budgetFields.forEach(field => {
            const val = budgetPlan[field] || 0;
            total += val;
            if (val > 0 && monthlyIncome > 0) {
                const pct = Math.min((val / monthlyIncome) * 100, 100);
                html += `
                    <div style="margin-bottom:8px">
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
                            <span>${budgetLabels[field]}</span>
                            <span>${format(val)} (${pct.toFixed(1)}%)</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-bar-fill" style="width:${pct}%;background:${budgetColors[field]}"></div>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        totalAllocatedEl.textContent = format(total);
        
        const remaining = monthlyIncome - total;
        remainingEl.textContent = format(Math.abs(remaining));
        remainingEl.classList.toggle('negative', remaining < 0);
        if (remaining < 0) {
            remainingEl.textContent = '-' + remainingEl.textContent;
        }
    }

    // Update income input to auto-calculate remaining
    document.getElementById('incomeInput').addEventListener('input', () => {
        monthlyIncome = Number(document.getElementById('incomeInput').value) || 0;
        updateIncomeDisplay();
        updateBudgetVisual();
    });

    // Update budget inputs to auto-calculate
    budgetFields.forEach(field => {
        document.getElementById('budget' + field).addEventListener('input', () => {
            const plan = {};
            budgetFields.forEach(f => {
                plan[f] = Number(document.getElementById('budget' + f).value) || 0;
            });
            budgetPlan = plan;
            updateBudgetVisual();
        });
    });

    // ===== AI BUDGET ADVISOR =====
    const aiSuggestionsEl = document.getElementById('aiSuggestions');
    
    document.getElementById('getAiAdvice').onclick = () => {
        generateSmartSuggestions();
    };

    function generateSmartSuggestions() {
        const suggestions = [];
        const total = Object.values(budgetPlan).reduce((s, v) => s + (v || 0), 0);
        
        if (monthlyIncome <= 0) {
            aiSuggestionsEl.innerHTML = '<div class="ai-suggestion warning">‚ö†Ô∏è Please enter your monthly income first to get personalized suggestions.</div>';
            return;
        }

        // Calculate percentages
        const pct = {};
        budgetFields.forEach(f => {
            pct[f] = ((budgetPlan[f] || 0) / monthlyIncome) * 100;
        });

        // Investment analysis (50-30-20 rule inspired)
        const investmentPct = pct.MF + pct.Stocks + pct.Gold;
        const expensesPct = pct.Rent + pct.Entertainment + pct.Shopping + pct.Food + pct.Other;
        const savingsPct = pct.Liquid;

        // Rule 1: Check if saving enough
        if (investmentPct < 20) {
            suggestions.push({
                type: 'warning',
                text: `üìà Your investments are ${investmentPct.toFixed(1)}% of income. Consider increasing to at least 20% for long-term wealth building.`
            });
        } else if (investmentPct >= 30) {
            suggestions.push({
                type: 'positive',
                text: `üéØ Excellent! You're investing ${investmentPct.toFixed(1)}% of your income. Great discipline!`
            });
        }

        // Rule 2: Emergency fund check
        if (pct.Liquid < 10) {
            suggestions.push({
                type: 'warning',
                text: `üíß Liquid money is only ${pct.Liquid.toFixed(1)}%. Keep at least 10-15% for emergencies and unexpected expenses.`
            });
        }

        // Rule 3: Rent/EMI check (shouldn't exceed 30-40%)
        if (pct.Rent > 40) {
            suggestions.push({
                type: 'danger',
                text: `üè† Rent/Bills/EMIs at ${pct.Rent.toFixed(1)}% is high. Try to keep it under 40% of income.`
            });
        } else if (pct.Rent > 0 && pct.Rent <= 30) {
            suggestions.push({
                type: 'positive',
                text: `üè† Great job keeping housing costs at ${pct.Rent.toFixed(1)}%!`
            });
        }

        // Rule 4: Entertainment + Shopping check
        const funPct = pct.Entertainment + pct.Shopping;
        if (funPct > 20) {
            suggestions.push({
                type: 'warning',
                text: `üõçÔ∏è Entertainment + Shopping at ${funPct.toFixed(1)}%. Consider limiting to 15-20% for better savings.`
            });
        }

        // Rule 5: Remaining balance
        const remaining = monthlyIncome - total;
        if (remaining < 0) {
            suggestions.push({
                type: 'danger',
                text: `‚ö†Ô∏è You've over-allocated by ${format(Math.abs(remaining))}! Reduce some categories.`
            });
        } else if (remaining > monthlyIncome * 0.1) {
            suggestions.push({
                type: 'warning',
                text: `üí° You have ${format(remaining)} unallocated (${((remaining/monthlyIncome)*100).toFixed(1)}%). Consider adding it to investments or emergency fund.`
            });
        }

        // Rule 6: Diversification check
        if (pct.MF > 0 && pct.Stocks === 0 && pct.Gold === 0) {
            suggestions.push({
                type: 'warning',
                text: `üé≤ Consider diversifying investments across MF, Stocks, and Gold for better risk management.`
            });
        }

        // Rule 7: Food budget check
        if (pct.Food > 25) {
            suggestions.push({
                type: 'warning',
                text: `üçî Food expenses at ${pct.Food.toFixed(1)}% seem high. Consider meal planning to reduce costs.`
            });
        }

        // Render suggestions
        if (suggestions.length === 0) {
            suggestions.push({
                type: 'positive',
                text: `‚ú® Your budget looks well-balanced! Keep up the good financial habits.`
            });
        }

        aiSuggestionsEl.innerHTML = suggestions.map(s => 
            `<div class="ai-suggestion ${s.type}">${s.text}</div>`
        ).join('');
    }

    // ===== GEMINI AI INTEGRATION =====
    document.getElementById('askGemini').onclick = async () => {
        const apiKey = document.getElementById('geminiKey').value.trim();
        if (!apiKey) {
            aiSuggestionsEl.innerHTML = '<div class="ai-suggestion warning">‚ö†Ô∏è Please enter your Gemini API key to use AI advice.</div>';
            return;
        }

        aiSuggestionsEl.innerHTML = '<div class="ai-loading">üîÑ Analyzing your budget with AI...</div>';

        const prompt = `You are a personal finance advisor. Analyze this budget and provide 3-5 specific, actionable suggestions to improve it.

Monthly Income: ${format(monthlyIncome)}
Budget Allocations:
- Rent/Bills/EMIs: ${format(budgetPlan.Rent || 0)} (${((budgetPlan.Rent || 0)/monthlyIncome*100).toFixed(1)}%)
- Mutual Funds: ${format(budgetPlan.MF || 0)} (${((budgetPlan.MF || 0)/monthlyIncome*100).toFixed(1)}%)
- Stocks: ${format(budgetPlan.Stocks || 0)} (${((budgetPlan.Stocks || 0)/monthlyIncome*100).toFixed(1)}%)
- Gold: ${format(budgetPlan.Gold || 0)} (${((budgetPlan.Gold || 0)/monthlyIncome*100).toFixed(1)}%)
- Entertainment: ${format(budgetPlan.Entertainment || 0)} (${((budgetPlan.Entertainment || 0)/monthlyIncome*100).toFixed(1)}%)
- Shopping: ${format(budgetPlan.Shopping || 0)} (${((budgetPlan.Shopping || 0)/monthlyIncome*100).toFixed(1)}%)
- Food & Groceries: ${format(budgetPlan.Food || 0)} (${((budgetPlan.Food || 0)/monthlyIncome*100).toFixed(1)}%)
- Other Expenses: ${format(budgetPlan.Other || 0)} (${((budgetPlan.Other || 0)/monthlyIncome*100).toFixed(1)}%)
- Liquid Money: ${format(budgetPlan.Liquid || 0)} (${((budgetPlan.Liquid || 0)/monthlyIncome*100).toFixed(1)}%)

Provide suggestions in a friendly, encouraging tone. Focus on:
1. Investment optimization
2. Emergency fund adequacy
3. Expense reduction opportunities
4. Risk diversification
5. Any imbalances`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response from AI';
            
            // Format the response
            const formatted = aiText
                .split('\n')
                .filter(line => line.trim())
                .map(line => `<div class="ai-suggestion positive">${line}</div>`)
                .join('');
            
            aiSuggestionsEl.innerHTML = '<div style="margin-bottom:8px;font-weight:600;color:#a78bfa">üß† Gemini AI Suggestions:</div>' + formatted;
            
        } catch (error) {
            aiSuggestionsEl.innerHTML = `<div class="ai-suggestion danger">‚ùå Error: ${error.message}</div>`;
        }
    };

    render();
</script>
<body>
<div class="app">
    <button id="loginBtn">Sign in with Google</button>
    <h1>Spendly</h1>
    <p>Couple AI-powered expense tracker</p>

    <div class="row">
        <input type="month" id="monthFilter" />
        <!-- Month selector fix: ensure clickable on mobile/desktop -->
    </div>

    <div class="row">
        <input id="amount" type="number" step="0.01" placeholder="Amount" />
        <select id="currency">
            <option value="INR">‚Çπ INR</option><option value="USD">$ USD</option><option value="EUR">‚Ç¨ EUR</option><option value="THB">‡∏ø THB</option><option value="MYR">RM MYR</option>
        </select>
    </div>

    <div class="row">
        <select id="category">
            <option>Food</option><option>Travel</option><option>Groceries</option><option>Shopping</option><option>Entertainment</option><option>Health</option><option>Common (Rent/Bills/EMIs)</option><option>Family Transfers</option><option>Bank Deposits</option><option>Mutual Funds/Stocks</option><option>Other</option>
        </select>
        <select id="owner"><option value="me">Nikku</option><option value="partner">Wifey</option></select>
    </div>

    <button id="addBtn">+ Add Expense</button>

    <!-- Monthly Expense Summary -->
    <div class="expense-summary">
        <div class="expense-summary-title">üìÖ This Month's Total Spending</div>
        <div class="expense-total" id="monthlyTotal">‚Çπ0.00</div>
        <div class="expense-split">
            <div class="expense-split-item">
                <div class="expense-split-label">Nikku</div>
                <div class="expense-split-value me" id="nikkuTotal">‚Çπ0</div>
            </div>
            <div class="expense-split-item">
                <div class="expense-split-label">Wifey</div>
                <div class="expense-split-value partner" id="wifeyTotal">‚Çπ0</div>
            </div>
        </div>
        <div class="expense-vs-budget" id="budgetComparison">
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
                <span>Budget Used</span>
                <span id="budgetUsedPct">0%</span>
            </div>
            <div class="expense-bar">
                <div class="expense-bar-fill" id="budgetUsedBar" style="width:0%;background:#4ade80"></div>
            </div>
            <div class="expense-status" id="budgetStatus"></div>
        </div>
    </div>

    <div id="list"></div>

    <canvas id="categoryPie" height="200"></canvas>
    <canvas id="trend" height="140"></canvas>
    <canvas id="compare" height="140"></canvas>

    <div class="ai" id="ai"></div>

    <!-- Income & Budget Section -->
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="section-title">üí∞ Monthly Income & Budget</span>
            <button class="collapse-btn" id="toggleBudget">‚ñº</button>
        </div>
        <div id="budgetSection" class="collapsible" style="max-height:2000px">
            <div class="income-row" style="margin-bottom:14px">
                <input type="number" id="incomeInput" placeholder="Monthly Income" style="flex:1" />
                <button id="saveIncomeBtn" style="width:auto;padding:12px 20px">Save</button>
            </div>
            <div id="incomeDisplay" style="display:none;margin-bottom:14px">
                <span style="color:var(--muted);font-size:12px">Monthly Income:</span>
                <span class="income-display" id="incomeAmount">‚Çπ0</span>
            </div>

            <div style="font-size:12px;color:var(--muted);margin-bottom:8px;font-weight:600">üìä Budget Allocations</div>
            
            <div class="budget-item">
                <label>üè† Rent/Bills/EMIs</label>
                <input type="number" id="budgetRent" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üìà Mutual Funds</label>
                <input type="number" id="budgetMF" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üìä Stocks</label>
                <input type="number" id="budgetStocks" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>ü™ô Gold</label>
                <input type="number" id="budgetGold" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üé¨ Entertainment</label>
                <input type="number" id="budgetEntertainment" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üõçÔ∏è Shopping</label>
                <input type="number" id="budgetShopping" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üçî Food & Groceries</label>
                <input type="number" id="budgetFood" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üì¶ Other Expenses</label>
                <input type="number" id="budgetOther" placeholder="0" />
            </div>
            <div class="budget-item">
                <label>üíß Liquid Money</label>
                <input type="number" id="budgetLiquid" placeholder="0" />
            </div>

            <button id="saveBudgetBtn">Save Budget Plan</button>

            <div id="budgetVisual" style="margin-top:14px"></div>

            <div class="budget-summary">
                <span>Total Allocated:</span>
                <span id="totalAllocated">‚Çπ0</span>
            </div>
            <div class="budget-summary" style="border:none;padding-top:0">
                <span>Remaining:</span>
                <span class="budget-remaining" id="budgetRemaining">‚Çπ0</span>
            </div>
        </div>
    </div>

    <!-- AI Budget Advisor -->
    <div class="ai-advisor">
        <div class="ai-advisor-title">ü§ñ AI Budget Advisor</div>
        <button class="ai-btn" id="getAiAdvice">‚ú® Get Smart Suggestions</button>
        <div id="aiSuggestions" class="ai-suggestions" style="margin-top:12px"></div>
        
        <div class="gemini-input">
            <input type="password" id="geminiKey" placeholder="Gemini API Key (optional)" />
            <button id="askGemini" style="width:auto;padding:12px 16px;font-size:12px">üß† Ask AI</button>
        </div>
        <p style="font-size:10px;color:var(--muted);margin-top:6px">Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color:var(--accent)">Google AI Studio</a></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="installPrompt" style="display:none;position:fixed;bottom:16px;left:16px;right:16px;background:#020617;border:1px solid #1e293b;border-radius:16px;padding:14px;color:#e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.6)">
    <strong>Install Spendly</strong>
    <p style="font-size:12px;color:#94a3b8;margin:6px 0">Track expenses faster from your home screen</p>
    <button id="installBtn">Install App</button>
</div>

<script>
    // ===== VERSION HANDLING =====
    const APP_VERSION = '1.2.0';
    const storedVersion = localStorage.getItem('app_version');
    if (storedVersion !== APP_VERSION) {
        localStorage.setItem('app_version', APP_VERSION);
        console.log('Spendly updated to version', APP_VERSION);
    }

    // ===== SERVICE WORKER REGISTRATION =====
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW registration failed:', err));
    }

    // ===== INSTALL PROMPT =====
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'block';
    });

    document.getElementById('installBtn').addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('installPrompt').style.display = 'none';
    });
</script>
</body>
</html>