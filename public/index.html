<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#020617" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>Spendly â€“ Couple AI Expense Tracker</title>
    <style>
        :root {
            --bg:#020617;--card:#0f172a;--accent:#38bdf8;--danger:#f87171;--text:#e5e7eb;--muted:#94a3b8;
        }
        *{box-sizing:border-box;font-family:Inter,system-ui}
        body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        .app{width:100%;max-width:460px;background:var(--card);border-radius:24px;padding:20px;box-shadow:0 25px 60px rgba(0,0,0,.6)}
        h1{margin:0;font-size:22px}
        p{margin:4px 0 12px;color:var(--muted);font-size:13px}
        .row{display:flex;gap:10px;margin-bottom:8px}
        input,select{
            width:100%;
            padding:12px;
            border-radius:14px;
            border:none;
            background:#020617;
            color:var(--text);
            font-size:14px;
            appearance:auto;
            -webkit-appearance:auto;
            pointer-events:auto;
        }
        button{width:100%;padding:14px;border-radius:16px;border:none;background:linear-gradient(135deg,#38bdf8,#6366f1);color:#020617;font-weight:800;cursor:pointer}
        ul{list-style:none;padding:0;margin:12px 0}
        li{background:#020617;padding:12px 14px;border-radius:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
        .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:#1e293b;color:var(--muted)}
        .pill.me{background:#1e40af;color:#bfdbfe}
        .pill.partner{background:#4c1d95;color:#ddd6fe}
        .delete{background:none;border:none;color:var(--danger);cursor:pointer}
        .ai{margin-top:12px;background:#020617;border-radius:16px;padding:12px;font-size:13px;color:var(--muted)}
        canvas{margin-top:14px}
    </style>
</head>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
        getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCVP058K-vfHdmNS3HkR7j9LofDG8i3Kdc",
        authDomain: "spendly-tracker.firebaseapp.com",
        projectId: "spendly-tracker",
        storageBucket: "spendly-tracker.firebasestorage.app",
        messagingSenderId: "193786715968",
        appId: "1:193786715968:web:43d3279fe2ef3049e8e4a5",
        measurementId: "G-2MPDP7KWGL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.firebase = { auth, db, provider };
    let expenses = [];
    function subscribeToExpenses() {
        const q = query(
            collection(db, "users", userId, "expenses"),
            orderBy("date", "desc")
        );

        onSnapshot(q, snapshot => {
            expenses = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            render();
        });
    }
    const loginBtn = document.getElementById('loginBtn');
    let userId = null;
    loginBtn.onclick = async () => {
        await signInWithPopup(auth, provider);
    };
    onAuthStateChanged(auth, user => {
        if (!user) return;
        userId = user.uid;
        loginBtn.style.display = 'none';
        subscribeToExpenses();
    });
    const monthFilter=document.getElementById('monthFilter');
    const amountInput=document.getElementById('amount');
    const currencyInput=document.getElementById('currency');
    const categoryInput=document.getElementById('category');
    const ownerInput=document.getElementById('owner');
    const list=document.getElementById('list');
    const aiBox=document.getElementById('ai');
    const trendCtx=document.getElementById('trend').getContext('2d');
    const compareCtx=document.getElementById('compare').getContext('2d');
    const categoryPieCtx=document.getElementById('categoryPie').getContext('2d');

    let trendChart=null,compareChart=null,categoryPieChart=null;

    monthFilter.value=new Date().toISOString().slice(0,7);
    monthFilter.addEventListener('change',render);
    async function addExpense() {
        monthFilter.value = new Date().toISOString().slice(0,7);

        const amount = Number(amountInput.value);
        if (!amount || amount <= 0) return;

        await addDoc(
            collection(db, "users", userId, "expenses"),
            {
                amount,
                currency: currencyInput.value,
                category: categoryInput.value,
                owner: ownerInput.value,
                date: new Date().toISOString()
            }
        );

        amountInput.value = "";
    }
    /*function addExpense(){
        monthFilter.value=new Date().toISOString().slice(0,7);
        const amount=Number(amountInput.value);
        if(!amount||amount<=0)return;
        expenses.push({id:Date.now(),amount,currency:currencyInput.value,category:categoryInput.value,owner:ownerInput.value,date:new Date().toISOString()});
        amountInput.value='';save();
    }*/

    document.getElementById('addBtn').onclick=addExpense;

    async function deleteExpense(id){
        await deleteDoc(doc(db, "users", userId, "expenses", id));
    }
    window.deleteExpense = deleteExpense;

    function render(){
        list.innerHTML='';
        const m=monthFilter.value;
        const filtered=expenses.filter(e=>e.date.startsWith(m));
        let me=0,partner=0;

        filtered.slice().reverse().forEach(e=>{
            if(e.owner==='me')me+=e.amount; else partner+=e.amount;
            const li=document.createElement('li');
            li.innerHTML=`<span>${e.category} <span class="pill ${e.owner}">${e.owner==='me'?'Nikku':'Wifey'}</span></span><span>${format(e.amount,e.currency)} <button class="delete" onclick="deleteExpense('${e.id}')">âœ•</button></span>`;
            list.appendChild(li);
        });

        renderCategoryPie(filtered);
        renderTrend();
        renderCompare();
        aiBox.innerHTML=generateAI(me,partner);
    }

    function generateAI(me,partner){
        if(me+partner===0)return'No entries this month';
        if(me>partner*1.5)return'ðŸ’¡ Nikku is spending much more this month';
        if(partner>me*1.5)return'ðŸ’¡ Wifey is spending much more this month';
        return`ðŸ’‘ Balanced month â€” Nikku ${format(me)} | Wifey ${format(partner)}`;
    }

    // ===== CATEGORY PIE CHART =====
    const categoryColors = {
        'Food': '#f87171',
        'Travel': '#fb923c',
        'Groceries': '#a3e635',
        'Shopping': '#38bdf8',
        'Entertainment': '#c084fc',
        'Health': '#4ade80',
        'Common (Rent/Bills/EMIs)': '#facc15',
        'Family Transfers': '#f472b6',
        'Bank Deposits': '#22d3ee',
        'Mutual Funds/Stocks': '#818cf8',
        'Other': '#94a3b8'
    };

    function renderCategoryPie(filtered) {
        if (categoryPieChart) categoryPieChart.destroy();
        
        const categoryTotals = {};
        filtered.forEach(e => {
            categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
        });
        
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const colors = labels.map(cat => categoryColors[cat] || '#94a3b8');
        
        if (labels.length === 0) return;
        
        categoryPieChart = new Chart(categoryPieCtx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderColor: '#0f172a',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 8, font: { size: 11 } }
                    },
                    title: {
                        display: true,
                        text: 'Category Breakdown',
                        color: '#e5e7eb',
                        font: { size: 14 }
                    }
                }
            }
        });
    }

    // ===== AUTO ARCHIVE + 6 MONTH TREND =====
    function lastMonths(n){
        const arr=[];const d=new Date();
        for(let i=0;i<n;i++){arr.unshift(new Date(d.getFullYear(),d.getMonth()-i,1).toISOString().slice(0,7));}
        return arr;
    }

    function renderTrend(){
        if(trendChart)trendChart.destroy();
        const months=lastMonths(6);
        const totals=months.map(m=>expenses.filter(e=>e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));
        trendChart=new Chart(trendCtx,{type:'line',data:{labels:months,datasets:[{data:totals,label:'6â€‘Month Trend'}]},options:{plugins:{legend:{labels:{color:'#94a3b8'}}}}});
    }

    // ===== MONTHâ€‘TOâ€‘MONTH COMPARISON =====
    function renderCompare(){
        if(compareChart)compareChart.destroy();
        const months=lastMonths(2);
        const totals=months.map(m=>expenses.filter(e=>e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));
        compareChart=new Chart(compareCtx,{type:'bar',data:{labels:months,datasets:[{data:totals,label:'Month Comparison'}]},options:{plugins:{legend:{labels:{color:'#94a3b8'}}}}});
    }

    const currencyMap={INR:{s:'â‚¹',l:'en-IN'},USD:{s:'$',l:'en-US'},EUR:{s:'â‚¬',l:'de-DE'},THB:{s:'à¸¿',l:'th-TH'},MYR:{s:'RM',l:'ms-MY'}};
    function format(n,c='INR'){const x=currencyMap[c]||currencyMap.INR;return x.s+n.toLocaleString(x.l,{minimumFractionDigits:2,maximumFractionDigits:2});}

    render();
</script>
<body>
<div class="app">
    <button id="loginBtn">Sign in with Google</button>
    <h1>Spendly</h1>
    <p>Couple AI-powered expense tracker</p>

    <div class="row">
        <input type="month" id="monthFilter" />
        <!-- Month selector fix: ensure clickable on mobile/desktop -->
    </div>

    <div class="row">
        <input id="amount" type="number" step="0.01" placeholder="Amount" />
        <select id="currency">
            <option value="INR">â‚¹ INR</option><option value="USD">$ USD</option><option value="EUR">â‚¬ EUR</option><option value="THB">à¸¿ THB</option><option value="MYR">RM MYR</option>
        </select>
    </div>

    <div class="row">
        <select id="category">
            <option>Food</option><option>Travel</option><option>Groceries</option><option>Shopping</option><option>Entertainment</option><option>Health</option><option>Common (Rent/Bills/EMIs)</option><option>Family Transfers</option><option>Bank Deposits</option><option>Mutual Funds/Stocks</option><option>Other</option>
        </select>
        <select id="owner"><option value="me">Nikku</option><option value="partner">Wifey</option></select>
    </div>

    <button id="addBtn">+ Add Expense</button>

    <ul id="list"></ul>

    <canvas id="categoryPie" height="200"></canvas>
    <canvas id="trend" height="140"></canvas>
    <canvas id="compare" height="140"></canvas>

    <div class="ai" id="ai"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="installPrompt" style="display:none;position:fixed;bottom:16px;left:16px;right:16px;background:#020617;border:1px solid #1e293b;border-radius:16px;padding:14px;color:#e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.6)">
    <strong>Install Spendly</strong>
    <p style="font-size:12px;color:#94a3b8;margin:6px 0">Track expenses faster from your home screen</p>
    <button id="installBtn">Install App</button>
</div>

<script>
    // ===== VERSION HANDLING =====
    const APP_VERSION = '1.2.0';
    const storedVersion = localStorage.getItem('app_version');
    if (storedVersion !== APP_VERSION) {
        localStorage.setItem('app_version', APP_VERSION);
        console.log('Spendly updated to version', APP_VERSION);
    }

    // ===== SERVICE WORKER REGISTRATION =====
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW registration failed:', err));
    }

    // ===== INSTALL PROMPT =====
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPrompt').style.display = 'block';
    });

    document.getElementById('installBtn').addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('installPrompt').style.display = 'none';
    });
</script>
</body>
</html>